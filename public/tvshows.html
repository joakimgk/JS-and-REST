<html>
<head>
  <title>tvshows</title>
  <script
  src="https://code.jquery.com/jquery-3.1.1.js"
  integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA="
  crossorigin="anonymous"></script>
</head>
<body>
  <h1>tvshows jQuery</h1>

  <script type = "text/javascript" language = "javascript">
    $(document).ready(function() {

       let tvShows = [];

       $("#driver").click(function(event){
         oppdaterData();
       });

       function oppdaterData() {
         console.log("oppdaterData()");
         $.get(
            "/tvshow",
            null,
            function(data) {
              oppdaterView(data);
            });
       }

       function oppdaterView(data) {

         console.log("oppdaterView()");
         $('#stage').html(null);
         tvShows = data;

         if (data === undefined || data === null) {
             console.log("no data");
             return;
           }

          var tbl=$('<table></table>');

          // lag header
          var tr=$('<tr></tr>');
          $.each(data[0], function(k, v){
              $('<th>'+k+'</th>').appendTo(tr);
          });
          tr.appendTo(tbl);

          // lag (klikkbare) rader
           $.each(data, function(key, val) {
               var tr=$('<tr class="tvshow" id=' + val.id + '></tr>');
               $.each(val, function(k, v){
                   $('<td>'+v+'</td>').appendTo(tr);
               });
               tr.appendTo(tbl);
           });

           tbl.appendTo('#stage');
       }

       // click handler on TR elements delegated to parent
       // element, <div id="stage">, since table is dynamically generated
       $("#stage").on("click", 'tr.tvshow', function() {
          rediger($(this).attr("id"));
       });

       function rediger(id) {
         let editShow = tvShows.find(show =>
             (show === undefined ? null : show.id) == id)
         $("#showID").text(editShow.id);
         $("#navn").val(editShow.name);
         $("#genre").val(editShow.genre);

         $("#hjelpetekst").text("Rediger show");
       }

       $("#avbryt").click(function(event){
         console.log("avbryt()");
         $("#showID").text(null);
         $("#navn").val(null);
         $("#genre").val(null);

         $("#hjelpetekst").text("Sett inn nytt show");
       });

       $("#lagre").click(function(event){
         console.log("lagre()");
         const vid = $("#showID").text();
         const vname = $("#navn").val();
         const vgenre = $("#genre").val();

         if (vname === null || vname === "") {
           alert("Navn kan ikke være blankt");
           return null;
         }

         const data = {
           navn: vname,
           genre: vgenre
         };

         if (vid === null || vid === "") {
           type = 'POST';
           url = '/tvshow';
         } else {
           url = '/tvshow/' + vid;
           type = 'PUT';
         }
         $.ajax({
            url: url,     //'/tvshow',
            type: type,   //'POST',
            data: data,
            success: function(result) {
                console.log(type + " OK: result = " + result);
                oppdaterData();  // refresh view
            }
        });
       });

       $("#slett").click(function(event){
         const deleteId = $("#delId").val();
         console.log("slett(" + deleteId + ")");
         if (deleteId == "") {
            alert("Du må oppgi en ID for sletting");
            return false;
          }
         $.ajax({
            url: '/tvshow/' + deleteId,
            type: 'DELETE',
            success: function(result) {
                oppdaterData();
            }
        });
       });





       // initiell last
       oppdaterData() ;


    });


 </script>

 <p>Tilgjengelige tv-show:</p>

 <div id="stage" style="background-color:#cc0;">
 </div>

    <hr/>
  <b id="hjelpetekst">Sett inn nytt show</b>
  <form>
    ID: <span id="showID"></span><br/>
    Navn: <input type="text" name="navn" id="navn"><br/>
    Sjanger: <input type="text" name="genre" id="genre"><br/>
    <input type="button" name="action" value="Avbryt" id="avbryt"/>
    <input type="button" name="action" value="Lagre" id="lagre"/>
    <hr/>

    <input type="button" name="action" value="Slett" id="slett" />
    id: <input type="text" name="delId" id="delId" size="1">
  </form>
</body>
</html>
